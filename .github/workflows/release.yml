name: ShankPit Factory

on:
  push:
    branches: [ "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: ðŸ—ï¸ Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW & SDL2
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 zip
          wget https://www.libsdl.org/release/SDL2-devel-2.28.5-mingw.tar.gz
          tar xzf SDL2-devel-2.28.5-mingw.tar.gz
          mv SDL2-2.28.5/x86_64-w64-mingw32 ./sdl2_mingw

      - name: Build Windows Client
        run: |
          # ADDED -lws2_32 -lwinmm -lgdi32 HERE
          x86_64-w64-mingw32-gcc apps/lobby/src/main.c -o ShankPit.exe \
            -O2 -static-libgcc \
            -I./sdl2_mingw/include -Ipackages/common -Ipackages/simulation \
            -L./sdl2_mingw/lib \
            -lmingw32 -lSDL2main -lSDL2 -lopengl32 -lglu32 -lws2_32 -lwinmm -lgdi32 -lm

      - name: Build Linux Server
        run: |
          # Server needs math lib (-lm) and networking
          gcc apps/server/src/main.c -o ShankServer_Linux -O2 -static -Ipackages/common -Ipackages/simulation -lm

      - name: Bundle Artifacts
        run: |
          mkdir ShankPit_Client
          cp ShankPit.exe ShankPit_Client/
          cp sdl2_mingw/bin/SDL2.dll ShankPit_Client/
          echo "start ShankPit.exe" > ShankPit_Client/PLAY.bat
          zip -r ShankPit_Windows.zip ShankPit_Client
          mv ShankServer_Linux ShankPit_Server_Linux

      - name: Upload Artifacts (Build)
        uses: actions/upload-artifact@v4
        with:
          name: ShankPit_Builds
          path: |
            ShankPit_Windows.zip
            ShankPit_Server_Linux

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ShankPit_Windows.zip
            ShankPit_Server_Linux

    - name: Set up GCC (Netcode)
      run: sudo apt-get update && sudo apt-get install -y build-essential

    - name: Compile Netcode Tests
      run: gcc apps/tests/test_netcode.c -o run_tests

    - name: Run Netcode Regression Suite
      run: ./run_tests
