name: ShankPit Factory

on:
  push:
    branches: [ "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: ðŸ—ï¸ Build, Test & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      # --- 1. SETUP ---
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 zip build-essential
          wget https://www.libsdl.org/release/SDL2-devel-2.28.5-mingw.tar.gz
          tar xzf SDL2-devel-2.28.5-mingw.tar.gz
          mv SDL2-2.28.5/x86_64-w64-mingw32 ./sdl2_mingw

      # --- 2. TESTS ---
      - name: Run Regression Suite
        run: |
          echo "ðŸ§ª Running Tests..."
          # Only running essential networking test to save time, full suite available if needed
          gcc apps/tests/test_netcode.c -o test_net -lm && ./test_net

      # --- 3. BUILD ARTIFACTS ---
      - name: Build Windows Client
        run: |
          echo "ðŸ”¨ Building ShankPit.exe..."
          x86_64-w64-mingw32-gcc apps/lobby/src/main.c -o ShankPit.exe \
            -O2 -static-libgcc \
            -I./sdl2_mingw/include -Ipackages/common -Ipackages/simulation \
            -L./sdl2_mingw/lib \
            -lmingw32 -lSDL2main -lSDL2 -lopengl32 -lglu32 -lws2_32 -lwinmm -lgdi32 -lm

      - name: Build Linux Server
        run: |
          if [ -f apps/server/src/main.c ]; then
            echo "ðŸ”¨ Building ShankServer_Linux..."
            gcc apps/server/src/main.c -o ShankServer_Linux -O2 -static -Ipackages/common -Ipackages/simulation -lm
          else
            echo "âš ï¸ Server source not found."
            touch ShankServer_Linux 
          fi

      - name: Build Bots (Windows & Linux)
        run: |
          echo "ðŸ”¨ Building Bots..."
          # Windows
          x86_64-w64-mingw32-gcc apps/client/bot_main.c -o ShankBot.exe -O2 -static-libgcc -Ipackages/common -Ipackages/simulation -lws2_32 -lwinmm || echo "âš ï¸ Win Bot Failed"
          # Linux
          gcc apps/client/bot_main.c -o ShankBot_Linux -O2 -static -Ipackages/common -Ipackages/simulation -lm || echo "âš ï¸ Lin Bot Failed"
          
          echo "âœ… Bots Build Verification:"
          ls -l ShankBot*

      # --- 4. GENERATE CONSTRUCT (The DNA) ---
      - name: Generate Source Construct
        run: |
          echo "ðŸ§¬ Generating SHANKPIT_CONSTRUCT.txt..."
          echo "SHANKPIT BUILD ${{ github.run_number }} CONSTRUCT" > SHANKPIT_CONSTRUCT.txt
          echo "=======================================" >> SHANKPIT_CONSTRUCT.txt
          
          # List of core files to bundle
          FILES="packages/common/protocol.h packages/common/physics.h packages/simulation/local_game.h apps/lobby/src/main.c apps/server/src/main.c apps/client/bot_main.c apps/training/headless.c"
          
          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "" >> SHANKPIT_CONSTRUCT.txt
              echo "--- FILE START: $file ---" >> SHANKPIT_CONSTRUCT.txt
              cat "$file" >> SHANKPIT_CONSTRUCT.txt
              echo "" >> SHANKPIT_CONSTRUCT.txt
              echo "--- FILE END: $file ---" >> SHANKPIT_CONSTRUCT.txt
            else
              echo "MISSING: $file" >> SHANKPIT_CONSTRUCT.txt
            fi
          done
          
          echo "âœ… Construct Generated."
          ls -l SHANKPIT_CONSTRUCT.txt

      # --- 5. PACKAGE ---
      - name: Bundle Artifacts
        run: |
          echo "ðŸ“¦ Bundling..."
          
          # Client Bundle
          mkdir ShankPit_Client
          cp ShankPit.exe ShankPit_Client/
          cp sdl2_mingw/bin/SDL2.dll ShankPit_Client/
          cp SHANKPIT_CONSTRUCT.txt ShankPit_Client/
          echo "start ShankPit.exe" > ShankPit_Client/PLAY.bat
          zip -r ShankPit_Windows.zip ShankPit_Client
          
          # Server Bundle
          mv ShankServer_Linux ShankPit_Server_Linux
          
          # Bot Bundle
          mkdir ShankPit_Bots
          # Only copy if they exist to prevent errors
          [ -f ShankBot.exe ] && cp ShankBot.exe ShankPit_Bots/
          [ -f ShankBot_Linux ] && cp ShankBot_Linux ShankPit_Bots/
          cp SHANKPIT_CONSTRUCT.txt ShankPit_Bots/
          zip -r ShankPit_Bots.zip ShankPit_Bots

      - name: Upload Artifacts (Build)
        uses: actions/upload-artifact@v4
        with:
          name: ShankPit_Builds
          path: |
            ShankPit_Windows.zip
            ShankPit_Server_Linux
            ShankPit_Bots.zip
            SHANKPIT_CONSTRUCT.txt

      # --- 6. RELEASE (Only on Tag) ---
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ShankPit_Windows.zip
            ShankPit_Server_Linux
            ShankPit_Bots.zip
            SHANKPIT_CONSTRUCT.txt


  deploy:
    name: ðŸš€ Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ShankPit_Builds
          
      - name: Deploy via SSH
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          source: "ShankPit_Server_Linux"
          target: "/opt/shankpit/"
          
      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script: |
            chmod +x /opt/shankpit/ShankPit_Server_Linux
            systemctl restart shankpit
            systemctl status shankpit
