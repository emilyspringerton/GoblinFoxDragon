name: ShankPit Factory

on:
  push:
    branches: ["master"]
    tags: ["v*"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build-linux:
    name: ğŸ—ï¸ Build (Linux) + Upload Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config \
            libsdl2-dev libgl1-mesa-dev libglu1-mesa-dev

      - name: ğŸ”¨ Build (force)
        run: |
          make clean || true
          make -B all

      - name: âœ… Verify outputs
        run: |
          ls -lah bin
          test -x bin/shank_lobby
          test -x bin/shank_server
          file bin/shank_lobby
          file bin/shank_server

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shankpit-linux-${{ github.sha }}
          path: |
            bin/shank_lobby
            bin/shank_server
          if-no-files-found: error

  release:
    name: ğŸš€ Release (tagged)
    runs-on: ubuntu-latest
    needs: build-linux
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: shankpit-linux-${{ github.sha }}
          path: dist

      - name: ğŸ“¦ Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/bin/shank_lobby
            dist/bin/shank_server
