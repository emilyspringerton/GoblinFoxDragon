name: ðŸ•µï¸ Debug Secrets

on: [push]

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Reveal Host (Encoded)
        run: |
          echo "Your DEPLOY_HOST (Base64 Encoded):"
          echo -n "${{ secrets.DEPLOY_HOST }}" | base64
          # Copy the output string and run 'echo STRING | base64 -d' on your PC to check it.

      - name: 2. Reveal User (Encoded)
        run: |
          echo "Your DEPLOY_USER (Base64 Encoded):"
          echo -n "${{ secrets.DEPLOY_USER }}" | base64

      - name: 3. Check Key Formatting
        run: |
          # We check the first line of the key to ensure it wasn't pasted weirdly
          FIRST_LINE=$(echo "${{ secrets.DEPLOY_KEY }}" | head -n 1)
          echo "Key Header Check: $FIRST_LINE"
          
          # Check line count (Should be > 1. If it is 1, you lost the newlines!)
          LINE_COUNT=$(echo "${{ secrets.DEPLOY_KEY }}" | wc -l)
          echo "Key Line Count: $LINE_COUNT"
          
          if [ "$LINE_COUNT" -eq 1 ]; then
            echo "âŒ ERROR: Private Key is one long line! You must preserve newlines."
            exit 1
          else
            echo "âœ… OK: Key has multiple lines."
          fi

      - name: 4. Network Connectivity Test
        run: |
          # Try to reach the server port
          nc -zv ${{ secrets.DEPLOY_HOST }} 22 || echo "âŒ Cannot reach server port 22"

      - name: 5. SSH Handshake Verbose
        run: |
          # Save key to file
          echo "${{ secrets.DEPLOY_KEY }}" > deploy_key
          chmod 600 deploy_key
          
          # Add to known hosts (CRITICAL STEP often missed)
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
          
          # Try to connect (Dry Run)
          echo "Attempting SSH connection..."
          ssh -vvv -i deploy_key -o ConnectTimeout=10 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo 'âœ… SUCCESS: Connection Established'"
