name: ShankPit Factory

on:
  push:
    branches: [ "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    name: ðŸ—ï¸ Build, Test & Package
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      # --- 1. SETUP ---
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            mingw-w64 \
            zip \
            build-essential \
            libncurses-dev

          wget https://www.libsdl.org/release/SDL2-devel-2.28.5-mingw.tar.gz
          tar xzf SDL2-devel-2.28.5-mingw.tar.gz
          mv SDL2-2.28.5/x86_64-w64-mingw32 ./sdl2_mingw

      # --- 2. BUILD CLIENT ---
      - name: Build Windows Client
        run: |
          x86_64-w64-mingw32-gcc apps/lobby/src/main.c \
            -o ShankPit.exe \
            -O2 -static-libgcc \
            -I./sdl2_mingw/include \
            -Ipackages/common \
            -Ipackages/simulation \
            -L./sdl2_mingw/lib \
            -lmingw32 -lSDL2main -lSDL2 \
            -lopengl32 -lglu32 -lws2_32 -lwinmm -lgdi32 -lm

      # --- 3. BUILD SERVER ---
      - name: Build Linux Server
        run: |
          gcc apps/server/src/main.c \
            -o ShankServer_Linux \
            -O2 -static \
            -Ipackages/common \
            -Ipackages/simulation \
            -lm

      # --- 4. BUILD WORLD CONTROLLER ---
      - name: Build Server Control (ncurses)
        run: |
          gcc apps/server/serverctl.c \
            -o shankpit_worldctl \
            -std=c99 \
            -O2 \
            -lncurses

      # --- 5. GENERATE CONSTRUCT ---
      - name: Generate Source Construct
        run: |
          echo "SHANKPIT BUILD ${{ github.run_number }} CONSTRUCT" > SHANKPIT_CONSTRUCT.txt
          FILES="
            packages/common/protocol.h
            packages/common/physics.h
            packages/simulation/local_game.h
            apps/lobby/src/main.c
            apps/server/src/main.c
            apps/server/serverctl.c
            apps/client/bot_main.c
          "
          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "--- FILE START: $file ---" >> SHANKPIT_CONSTRUCT.txt
              cat "$file" >> SHANKPIT_CONSTRUCT.txt
              echo "--- FILE END: $file ---" >> SHANKPIT_CONSTRUCT.txt
            fi
          done

      # --- 6. PACKAGE ---
      - name: Bundle Artifacts
        run: |
          mkdir ShankPit_World
          cp ShankServer_Linux ShankPit_World/
          cp shankpit_worldctl ShankPit_World/
          cp SHANKPIT_CONSTRUCT.txt ShankPit_World/
          echo "./shankpit_worldctl" > ShankPit_World/START_WORLD.sh
          chmod +x ShankPit_World/START_WORLD.sh
          zip -r ShankPit_World.zip ShankPit_World

          mkdir ShankPit_Client
          cp ShankPit.exe ShankPit_Client/
          cp sdl2_mingw/bin/SDL2.dll ShankPit_Client/
          cp SHANKPIT_CONSTRUCT.txt ShankPit_Client/
          echo "start ShankPit.exe" > ShankPit_Client/PLAY.bat
          zip -r ShankPit_Client.zip ShankPit_Client

          mkdir ShankPit_Bots
          gcc apps/client/bot_main.c -o ShankBot_Linux -O2 -static -Ipackages/common -Ipackages/simulation -lm || true
          [ -f ShankBot_Linux ] && cp ShankBot_Linux ShankPit_Bots/
          cp SHANKPIT_CONSTRUCT.txt ShankPit_Bots/
          zip -r ShankPit_Bots.zip ShankPit_Bots

      # --- 7. UPLOAD ---
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShankPit_Builds
          path: |
            ShankPit_World.zip
            ShankPit_Client.zip
            ShankPit_Bots.zip
            SHANKPIT_CONSTRUCT.txt

